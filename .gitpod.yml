image:
  file: .gitpod.Dockerfile
  context: .

tasks:
  - name: Workspace Setup
    init: |
      direnv allow
      git remote add upstream https://github.com/gitpod-io/workspace-images
    before: |
      direnv allow; direnv reload
      git fetch --all
      gp sync-done docker-cli-login
    command:
      docker run -p 5000:5000 --name registry --rm -v /workspace/registry:/var/lib/registry registry:2
      REPO=localhost:5000 ./devkit/introbaut
      
  # TODO: Implement GitHub Container Registry-as-artifact store soon.
  - name: Docker CLI Auth + Buildkitd
    before: |
      gp sync-await docker-cli-login
      direnv reload
      RHQCR_USERBOT_USERNAME=$RHQCR_USERNAME RHQCR_USERBOT_PASSWORD=$RHQCR_PASSWORD ./.gitlab/ci/scripts/docker-cli-login
    command: ./devkit/gp-buildkit

ports:
  - port: 5000
    onOpen: ignore

vscode:
  extensions:
    - ms-azuretools.vscode-docker
    - timonwong.shellcheck
    - redhat.vscode-yaml
    - eamodio.gitlens
    - gitlab.gitlab-workflow
    - davidanson.vscode-markdownlint
    - vivaxy.vscode-conventional-commits
github:
  prebuilds:
    master: true
    branches: true
    pullRequests: true
    pullRequestsFromForks: true
    addCheck: true
    addComment: true
